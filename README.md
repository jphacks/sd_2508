# 見守りカード -mimoca-

[![IMAGE ALT TEXT HERE](https://github.com/jphacks/sd_2508/blob/main/image/mimoca_home.png)](https://youtu.be/AdLN6ilkmZE)
### ⇧⇧⇧画像をクリックすると動画に飛べます！！
https://youtu.be/AdLN6ilkmZE

webアプリケーションURL: ログインが必要です
[https://mimamoricard-2b3f6.web.app/](https://mimamoricard-2b3f6.web.app/)

## 製品概要

LoRa通信とBLE、GPSを組み合わせた包括的な見守りシステムのWebアプリケーション。スマートフォンを持たない幼児や高齢者にカードトラッカーを持たせ、保護者がいつでもどこでもWebアプリで位置を確認できる。

### 背景（製品開発のきっかけ、課題等）

近年、保育園の子供バス置き去りによる熱中症・死亡事故や保育士不足による監視の目の不足が起きている。そこで、スマートフォンを持たない幼児や高齢者といった方を、保護者が安心して、また遠隔から見守ることができるようにしたいと考え、mimocaを開発した。

#### 社会的な課題
- **通園バスへの幼児置き去り事件**: 近年多発
- **高齢者の徘徊**: 認知症患者の行方不明事件の増加
- **スマホを持たせられない年齢層の見守り**: 幼児や認知症高齢者への見守りの難しさ

LoRaWANカードトラッカーとBLEビーコン、GPSを組み合わせることで屋内や屋外、乗り物の中といった異なる環境下でも情報をwebアプリケーション上で提供し、安心を届けることを目指している。


#### 本システムによる解決策

- **屋内検知**: Fingerprinting法によるBLE三点測位で、数m単位の高精度な室内位置推定
- **バス置き去り検知**: BLEビーコン1台で移動物内の置き去りを検知
- **屋外追跡**: GPSを用いて、外出しても位置情報を低消費電力で定期送信
- **LoRa通信**: 最大10kmまで届く通信を用いることで、携帯電話がなくても安心
- **Webアプリでの一元管理**: 屋内・屋外の位置データを、作成したルームや地図上にリアルタイムに可視化

### 製品説明（具体的な製品の説明）

本システムは3つのモードを持つハイブリッド見守りシステムです：

1. **室内位置追跡モード（機能1）**: BLEビーコン3台を使用した高精度な室内位置推定
2. **バス置き去り検知モード（機能2）**: BLEビーコン1台によるバス内での置き去り検知
3. **屋外GPS追跡モード（機能3）**: GPSによる保護者と被保護者の間の距離を監視

![System Flow](image/diagram.drawio.svg)

### 特長

#### 1. ハイブリッド測位
システムの最大の特徴は、3つの異なる通信技術を適材適所で使い分けるハイブリッド構成です。

- **LoRaWAN**: カードトラッカーからゲートウェイへの長距離（最大10km）・低消費電力なデータ通信のバックボーンとして活用
- **BLE（Bluetooth Low Energy）**: 屋内や車内など、GPSが不得意な閉空間での近距離・高精度な測位に使用
- **GPS**: 屋外での広範囲な位置特定に使用

#### 2. シナリオに基づいた3つのモード切り替え機能
「部屋」「バス」「屋外」という明確な利用シーンに合わせて、ユーザーが手動で機能を切り替えるUIを採用しています。これにより、ユーザーは現在の状況に合った最適な情報を得ることができます。

#### 3. Fingerprinting法による高精度屋内測位
本システムでは屋内での測位精度を向上させるため、**Fingerprinting法（指紋法）** を採用しています。これは、利用者がキャリブレーション機能を使って部屋の複数地点（4隅+中央+出入口）の電波強度を実測し、その部屋専用のプロファイルを事前に作成する方式です。

**実装した独自アルゴリズム:**
- 三辺測量（Gauss-Newton法）とFingerprinting法の自動重み付け併用
- 環境に応じた動的な重み調整により、より正確な位置推定を実現
- 追加キャリブレーションポイント機能により、測位精度を段階的に向上可能

#### 4. 固定データレートによる安定したRSSI測定
現在主流のADR（自動データレート設定）は、ネットワークの状態によりデータレートを変更するため同じ位置でも受信電力（RSSI）が変動します。本システムでは**データレートを低レートに固定化**することで、同一地点での安定したRSSI測定を実現しています。


### 解決できること

本システムにより、以下の見守り課題を解決できます：

- **子供や高齢者の部屋・建物からの離脱検知**: BLE三点測位により部屋内の位置を高精度に把握し、出入口の通過を即座に検知
- **バスへの置き去り検知**: BLE検知範囲の監視により、車内に一人取り残されている状態を検出
- **屋外での見失い防止**: GPS追跡により、保護者との距離が一定以上離れた際に警告
- **リアルタイム位置監視**: Webアプリケーションで被保護者の現在位置をリアルタイムに確認可能

### 今後の展望

- ビーコンをバスなどに乗せ、ビーコンからトラッカー所持者らが一定の範囲内にいるかを確認できる機能の実装
- 親トラッカー(GPS 機能あり)を 1 つ以上決め、他の子トラッカーが親トラッカーから離れていないか確認する機能の実装

### 注力したこと（こだわり等）

#### 技術面
- **Fingerprinting法の実装**: 既存ライブラリに頼らず、三辺測量とのハイブリッドアルゴリズムを独自実装
- **キャリブレーション機能の充実**: 7ポイント測定（4隅+中央+出入口2箇所）に加え、追加ポイント機能により精度向上を実現

#### UI/UX面
- **ユーザーフレンドリーなデザイン**: 直感的で使いやすいインターフェース
- **非技術者でも使える操作性**: マニュアル不要で利用できるシンプルな導線設計
- **視覚的なフィードバック**: 警告表示、位置可視化など、状況が一目で分かる画面設計

#### システムアーキテクチャ
- **IoTとクラウドの連携**: BLE → LoRa → LNS（LoRaWAN Network Server） → Cloud というパイプライン処理
- **リアルタイム性の確保**: Firebase Realtime Databaseによる即座のデータ同期

## 開発技術

### 技術スタック

#### フロントエンド
- **React 18**: モダンなUIライブラリ
- **TypeScript**: 型安全な開発環境
- **Vite**: 高速なビルドツール
- **React Router**: SPA用ルーティング
- **Leaflet / React-Leaflet**: 地図表示とインタラクティブな位置可視化

#### バックエンド
- **Firebase**
  - **Firestore**: ユーザー・デバイス・部屋情報の永続化
  - **Realtime Database**: リアルタイムな位置情報の同期
  - **Authentication**: ユーザー認証
  - **Cloud Functions**: Pub/Subからのデータ処理（Python）
- **Google Cloud Platform**
  - **Pub/Sub**: ChirpStackからのデータストリーミング
  - **Cloud Functions**: サーバーレスデータ処理

#### IoTインフラストラクチャ
- **ChirpStack**: LoRaWANネットワーク用オープンソースネットワークサーバー
- **Docker**: ChirpStackのコンテナ化

### 活用した技術

#### API・データ
- **LoRaWAN**: 長距離・低消費電力IoT通信プロトコル
- **BLE（Bluetooth Low Energy）**: 近距離無線通信による位置測位
- **RSSI（Received Signal Strength Indicator）**: 電波強度による距離推定
- **GNSS（GPS）**: 屋外位置情報取得
- **3軸加速度センサー**: トラッカーの動き検知（SenseCAP T1000内蔵）

#### 使用したフレームワーク・ライブラリ
- **React 18** + **TypeScript**: フロントエンド開発
- **Firebase SDK**: バックエンド連携
- **Leaflet**: オープンソース地図ライブラリ
- **ChirpStack**: LoRaWANネットワークサーバー（OSS）
- **Python Functions Framework**: Cloud Functions開発

### 使用デバイス

| デバイス | 型番 | 用途 | 台数 |
|---------|------|------|------|
| **BLEビーコン** | MM-BLEBC4 | 室内位置測位・バス検知用の基準点 | 3台 |
| **LoRaカードトラッカー** | SenseCAP T1000-A LoRaWAN | 保護者や被保護者が携帯する追跡デバイス | 3台 |
| **LoRaWANゲートウェイ** | SenseCAP M2 | LoRa信号の受信とインターネット接続 | 1台 |
| **Raspberry Pi** | LoRaネットワークサーバー（ChirpStack） | LoRaWANデータの処理と管理 | 1台 |

### 独自技術

#### ハッカソンで開発した独自機能・技術

##### 1. ハイブリッド位置推定アルゴリズム
- **Fingerprinting法と三辺測量の自動重み付け併用**
  - 三辺測量（Gauss-Newton法による最適化）とFingerprinting法（k-NN + 加重平均）を組み合わせ
  - キャリブレーションデータの充実度に応じて自動的に重みを調整
  - 環境の電波状況に応じた最適な測位手法の選択を実現

##### 2. 動的キャリブレーション機能
- **新規部屋での柔軟な対応**
  - 非技術者でも使える7ポイント測定ワークフロー（4隅+中央+出入口2箇所）
  - 既存のビーコンを別の部屋で再利用可能
  - 追加キャリブレーションポイント機能により、段階的な精度向上が可能
  - 家具配置によるマップのカスタマイズ機能

##### 3. 固定データレート方式による安定RSSI測定
- **ADR（自動データレート設定）の課題解決**
  - データレートを低レートに固定することで、同一地点でのRSSI値の安定性を向上
  - 高データレートはノイズに弱いが、低レートで信頼性の高い測定を実現
  - 位置推定精度の向上に大きく貢献

##### 4. IoTパイプライン処理の実装
- **BLE → LoRa → LNS → Cloud の一貫したデータフロー**
  - SenseCAP T1000がBLEビーコンをスキャンし、RSSIデータを取得
  - LoRaWAN経由でゲートウェイ（SenseCAP M2）に送信
  - ChirpStack（LoRaWAN Network Server）でデータを処理
  - Google Cloud Pub/Sub経由でFirebase Cloud Functionsにデータを送信
  - Pythonでペイロードをデコード（Frame ID 0x08対応）し、Firebase RTDBに保存
  - Reactアプリがリアルタイムにデータを取得して位置を表示

##### 5. モード切り替え型アーキテクチャ
- **3つの独立したモードによる最適化**
  - 各シーンに特化した機能提供
  - どんな部屋にも対応できる柔軟なキャリブレーション機能
  - 統一されたUI/UXでの直感的な操作性
