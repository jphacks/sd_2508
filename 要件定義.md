# 要件定義

## 概要

これはLoRa通信を用いた見守りシステムである。基本動作はカードトラッカーとビーコンを用いて、ユーザーがどこにいるかを見守ることである。

### 想定ユーザー
- **保護者**: Webアプリの使用対象者
- **被保護者**: カードトラッカーを所持して監視される対象者（スマホを持たない幼児や老人を想定）

被保護者にトラッカーを持ち歩かせ、彼らの位置情報を保護者がWebアプリで追跡する。

### システムの特徴
- **ゲートウェイ**: 建物に固定
- **データ送信頻度**: 1分間隔でRTDBが更新される
- **通信**: LoRa通信の長距離特性を活用

---

## 3つの主要機能

### 機能1: 室内見守り（ビーコン×3）

**概要**: 部屋にビーコン3つを固定し、部屋のどこにトラッカー所持者がいるかを確認できる機能。

**特徴**:
- ビーコン3台による位置特定を活用
- 使用技術: FingerPrintingモデル（または適切な位置推定モデル）
- BLE機能を使用

**警告機能**: 
- 部屋から出てしまった場合、画面で警告（赤色ポップアップなど）を表示

### 機能2: 乗り物内見守り（ビーコン×1）

**概要**: バスなど移動物にビーコン1台を固定し、ビーコンが検知するトラッカーの数をチェック。

**特徴**:
- ビーコンを持ち運び、トラッカー所持者らが一定範囲内にいるかを確認
- BLE機能を使用

**警告機能**:
- ビーコンからBLEを受信しているトラッカー（被保護者）が1台のみの状態が3分続いた場合
- バスから降り忘れている疑いありと判定し、警告を表示
- ※背景: 近年、通園バスに幼児を置き去りにする事件が多発

### 機能3: 屋外見守り（ビーコン×0）

**概要**: 散歩など屋外にいる際に、保護者（親トラッカー）から被保護者（子トラッカー）が逸れていないかをGPSでチェック。

**特徴**:
- 親トラッカー（GPS機能あり）を1つ以上設定
- 他の子トラッカーが親トラッカーから離れていないかを確認
- GPS機能のみを使用（BLE不使用）

**警告機能**:
- いずれかの親トラッカーから30m以上離れた場合、逸れたと検知
- 距離の閾値はUIで変更可能
- 誰か逸れた場合は警告を表示
---

## UI設計

### 基本仕様
- **機能の切り替え**: 機能1〜3は同時には使用せず、1つのみを有効化
- 管理画面で保護者が手動で切り替え
- 切り替え先の機能でキャリブレーションが未実施の場合、キャリブレーション画面に自動遷移

### 画面構成

#### 1. 基本画面（マップ表示）

**機能1の場合**:
- 部屋のマップとカードトラッカー所持者の位置を大きく表示

**機能2の場合**:
- ビーコンを中心としたマップを大きく表示

**機能3の場合**:
- トラッカーのGPS機能を使って、大まかなトラッカーの位置情報を表示

**共通**:
- 機能1〜3を通じて、画面全体で警告（音と共に）を知らせる通知を表示

#### 2. キャリブレーション・マップカスタマイズ画面

詳細はキャリブレーション案を参照

#### 3. 管理画面

**機能**:
- トラッカーの登録（トラッカーとユーザー名の対応付け）
- ビーコンの登録（ビーコンの名前付け）
- キャリブレーションでは名前のあるビーコンをマップ上に配置可能
---

## キャリブレーション仕様

### 機能1向けキャリブレーション（室内見守り）

#### 1. 目的

新しい部屋にビーコンを3つ置いただけでは、システムはトラッカーがどこにいるか分かりません。この「部屋スキャン」機能は、その部屋専用の「電波の地図」をシステムに作らせるための準備作業です。この地図があることで、その部屋でどの位置にいるかが分かるようになります。

#### 2. この機能でやること

- システムに「会議室A」のような新しい部屋の名前と、そこに置いたビーコン3つのIDを登録（他の部屋で使っているビーコンを使い回すのが基本）
- LoRaカードトラッカーを持って部屋を歩き回り、指示された場所で電波の強さを記録（スキャン作業）
- 記録したデータをシステムに送ると、その部屋専用の「電波の地図（部屋プロファイル）」が自動作成される
- 地図が正しく作成できたか、最後に簡単なテストが可能

#### 3. 対象ユーザー

一般人、主に保護者（非技術者でもできるようなUI・説明を提供）

#### 4. 作業フロー

##### ステップ1: 準備

**部屋の新規登録**
- 管理画面から、新しい部屋の名前（例: 「会議室A」）と、そこに設置したビーコン3つのIDを登録（もしくは再利用）

**ビーコンの設置**
- 物理的にビーコンを部屋に設置

##### ステップ2: スキャン作業

**スキャン開始**
- アプリで作業する部屋（例: 「会議室A」）を選んで「スキャン開始」ボタンを押す

**部屋の中を測定（5ヶ所）**
- 画面に「①部屋の隅に行ってください」のように、次に行く場所が分かりやすく表示
- 測定に使用するトラッカーは測定点ごとに選択可能
- 指示された場所に着いたら「ここで測定」ボタンを押す
- 「測定中…」と表示され、RTDBのそのトラッカーにおける値が変わったら、その値を測定結果と判定して使用
- 完了すると「OKです。次は左回りで次の隅に行ってください」のように、次の指示が出る
- 4点計測後は、部屋の中央で測定
- 合計5ヶ所（部屋の4隅 + 部屋の中央）で測定

**出入口を測定（2ヶ所以上）**
- 部屋の中の測定が終わると、「ドアの内側で測定してください」「ドアの外側で測定してください」という指示が出る
- 同じように2ヶ所で測定
- ※部屋に出入口が2つ以上ある場合も想定

**データ送信**
- 全ての測定が終わると「完了してデータを送信」ボタンが表示
- ボタンを押して現場の作業完了

##### ステップ3: 電波の地図づくり（システムが自動処理）

**「電波の地図」の作成と保存**
- 現場からデータが送られてくると、システムが自動で計算を開始
- その部屋の「どこで、どんな強さの電波が受信できるか」をまとめた、その部屋専用の「電波の地図（部屋プロファイル）」が作成・保存される

##### ステップ4: 最後のチェック

**テスト機能**
- 地図が完成すると、アプリに「テストをしますか？」と表示
- 「はい」を選ぶと、「部屋の真ん中にトラッカーを置いてください」と指示
- トラッカーを置くと、画面に「実際の場所とのズレ: 約 〇〇 cm」のように精度が表示
- この結果を見て、「この設定でOK」か「もう一度やり直す」かを選択可能

**キャリブレーション点追加機能**
- 部屋の4隅やドアの出入り口だけのキャリブレーションでは、不安定な可能性が高い
- 作成された部屋の任意の場所に点を置き、そこでのトラッカーのBLE測定結果も使用可能
- このキャリブレーション点追加機能は、キャリブレーション後いつでも追加可能
- 特定の位置だけ再キャリブレーションできる機能も提供

##### ステップ5: 家具配置

**マップを見やすくする**
- マップのアウトライン生成後に、簡易的にユーザーが事前に用意された家具等オブジェクトを配置可能（机、テレビ、ピアノ、ドアなど）
- ビーコンの位置は自動取得できないため、ここでセットしたビーコン3つの位置をマップ上に記録

#### 5. 重要な要件

**かんたんな操作**
- 誰でもマニュアルなしで使えるよう、アプリのボタンや指示はシンプルで分かりやすく

**途中で失敗しても安心**
- 測定の途中でアプリが止まっても、かんたんにやり直せる仕組み

**速さ**
- 現場でデータを送信してから、「電波の地図」ができるまでの待ち時間は30秒以内

---

### 機能2向けキャリブレーション（乗り物内見守り）

どのビーコン1台を使用するかを決定する。

---

### 機能3向けキャリブレーション（屋外見守り）

ビーコンは使わないので、ビーコンのキャリブレーションは不要。UIで機能3に切り替え、親トラッカーを選択できるようにするだけで良い。


キャリブレーション案（機能2向け)
どのビーコン1台を使用するか決定する。

キャリブレーション案（機能3向け)
ビーコンは使わないので、ビーコンのキャリブレーションは不要。UIで機能3に切り替え、親トラッカーを選択できるようにするだけで良い。


---

## BLEビーコン設置ガイド

### 注意点

**精度が低下する環境**:
- 金属やコンクリートの壁などの障害物が多い環境
- 他デバイスの電波が多い環境

### 設置場所の推奨

**基本**:
- 壁への設置が主流
- 床から1.5〜2m以上の高さの位置がベスト

**具体例**:
- 会場にドアが2つある場合: 2つのドア上の時計の直下へビーコンを設置
- 残り1つ: 会場窓側の中間地点
- 部屋の出入りを監視したい場合: ドアの正面方向の壁に設置

### 設置方法

両面テープまたはガムテープを使用

---

## 使用デバイス一覧

### BLE Beacon（×3）
- **型番**: MM-BLEBC4

### LoRa カードトラッカー
- **型番**: SenseCAP T1000-A LoRaWAN
- **Card A**: EUI `2CF7F1C07030002F`
- **Card B**: EUI `2CF7F1C06490088C`
- **Card C**: EUI `2CF7F1C0703000AD`

### LoRaWAN ゲートウェイ
- **型番**: SenseCAP M2 マルチプラットフォーム LoRaWAN

---

## データベーススキーマ

### Firestore / RealtimeDatabase (RTDB) に保存される値

#### 1) デバイス台帳（デバイスの管理）

**場所**: Firestore  
**パス**: `devices/{Id}/`（IdはFirestoreが自動決定）

```json
{
  "deviceId": "CARD-A",                    // CARD-A, CARD-B, ...
  "devEUI": "11:22:33:44:55:66",      
  "model": "SenseCAP T1000-A",
  "ownerUid": "<FirebaseAuth UID>",
  "status": "active",
  "tags": {
    "username": "(ユーザー名)"
  },
  "lorawan": {                             // 鍵はSecret Managerへ
    "devEUI": "...", 
    "joinEUI": "...", 
    "appEUI": "..."
  },
  "firmware": "1.2.0"
}
```

#### #### 2) トラッカー観測データ

**場所**: RealtimeDatabase

```json

**場所**: RealtimeDatabase
``` json
{
  "tracker": {
    "trackerID": {
      "ts": "2025-10-14T12:34:56Z",             // 観測の基準時刻（端末生成時刻）
      "server_ts": { ".sv": "timestamp" },       // サーバ受信時刻（ミリ秒）
      "seq": 128,                                 // 任意: 端末側の連番/フレーム番号（欠落検知に便利）
      "battery_dV": 39,                           // 任意: 3.9V→39（10倍整数など）

      "gps": {
        "lat": 38.2601,
        "lon": 140.8699,
        "alt": 67.2,
        "hdop": 0.9,                              // or "acc_m": 5.3
        "speed_mps": 0.7,
        "fix": true                               // 任意: 有効Fixか（失敗時はfalse/欠落）
      },

      "ble": {
        "beaconId": {                              // 複数のビーコン(DEVICE1, DEVICE2, DEVICE3)から送られてくる
          "channel": 37,                           // 任意
          "scanner": {                             // 任意
            "kind": "tracker", 
            "appVer": "1.0.0"
          },
          "loc_hint": {                            // 任意
            "lat": 38.26, 
            "lon": 140.87
          },
          "rssi_data": [                           // 1つのビーコンから最大3つの観測値が送られてくる
            { 
              "mac": "AA:BB:CC:DD:EE:01", 
              "rssi": -68, 
              "txPower": 4 
            },
            { 
              "mac": "AA:BB:CC:DD:EE:01", 
              "rssi": -72, 
              "txPower": 4 
            }
          ]
        }
      },

      "status": "ok",                              // 任意: "ok" | "degraded" | "no_gps" | "no_ble" など
      "tags": ["person", "asset"],                 // 任意
      "_v": 1                                      // スキーマバージョン
    }
  }
}
```

**クエリ最適化のためのフラットインデックス（後で追加）**:
`rssi_samples` コレクションに「1ビーコン1ドキュメント」でファンアウト保存すると、「特定ビーコン×期間のRSSI履歴」を高速に引けます。

#### 3) ビーコン台帳（固定機器・設置物）

**場所**: Firestore  
**パス**: `beacons/{Id}/`（IdはFirestoreが自動決定）

```json
```

クエリ最適化のためのフラットインデックス（後で追加）
 rssi_samples コレクションに“1ビーコン1ドキュメント”でファンアウト保存すると、「特定ビーコン×期間のRSSI履歴」を高速に引けます。
3) ビーコン台帳（固定機器・設置物）
firestore
beacons/{Id}/（Id は firestoreが自動で決定）
``` json
{
  "mac": "AA:BB:CC:DD:EE:FF",
  "beaconId": "DEVICE1",                   // DEVICE1~3まである
  "rssiAt1m": -59,                         // キャリブ基準
  "tags": {
    "type": ["ibeacon"]
  }
}
```

#### 4) 位置融合（GPS + BLE + 地図）

**場所**: RealtimeDatabase  
**パス**: `devices/{deviceId}/fused_positions/{posId}`

**説明**:  
バックエンドで受け取った電波強度とキャリブレーションデータを元に、サーバ側推定の結果を保存。可視化や履歴検索はここを主に使用。

```json```


```


4) 位置融合（GPS + BLE + 地図）
realtime database

ここは、バックエンドで受け取った電波強度とキャリブレーションデータを元に、

サーバ側推定の結果を保存する。可視化や履歴検索はここを主に使う。
 devices/{deviceId}/fused_positions/{posId}
``` json
{
  "ts": { "_seconds": 173... },
  "loc": { 
    "lat": 38.26008, 
    "lon": 140.86992, 
    "floor": 3 
  },
  "xy": {                                  // フロア内ローカル座標 [座標は0~1で正規化して表示するのが良いかも]
    "x": 12.84, 
    "y": 7.21
  },
  "cov_xy": [                              // 不確かさ（共分散）
    [0.52, 0.10], 
    [0.10, 0.30]
  ],
  "uncertainty_ellipse": {                 // 必要なければ削除
    "semi_major": 1.0,
    "semi_minor": 0.6,
    "theta_deg": 30.0
  },
  "method": "gps_only|ble_trilateration|kalman|particle",  // 必要なければ削除
  "confidence": 0.82,
  "inputs": {
    "gps_ref": "gps_fixes/2025-10-14T12:34:56Z",
    "scan_ref": "ble_scans/2025-10-14T12:34:55Z",
    "beacons_used": ["beacons/AA..", "beacons/BB.."]
  }
}
```

---

## LoRaWAN データフォーマット

### カードデバイスからLoRaへのデータ

**内容**: 3つのBLEデータとGPSデータを格納

```json



```

カードデバイスからLoRaへのデータ
3このBLEデータとgpsデータを格納
``` json
{
  "time": "2025-10-14T12:34:56Z",
  "gps": { 
    "lat_e5": 3826010, 
    "lon_e5": 14086990, 
    "acc_m": 6 
  },
  "battery_dV": 39,                        // 3.9Vを10倍整数など（任意）
  "beacons": [
    { "id3": "01FFAA", "rssi": -66 },
    { "id3": "02BBCC", "rssi": -74 },
    { "id3": "03CCDD", "rssi": -81 }
  ]
}
```

---