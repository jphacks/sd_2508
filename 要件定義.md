以下は今回作成して欲しいシステムの要件定義です。3つの機能のうち、機能1を実装してください。機能2、 3はモックだけ作成してください（GPSを用いる機能3のモックでは、宮城県仙台市青葉区荒巻青葉6−3付近の地図を表示してください）。また、Webアプリの見た目は https://pomunity.com/ を参考にしてください。また、細かい未実装の部分はTODO: とコメントを付けてください。
概要
これはLoRa通信を用いた見守りシステムである。基本動作はカードトラッカーとビーコンを用いて、ユーザーがどこにいるかを見守ることである。このシステムのユーザーは保護者（Webアプリの使用対象者）と被保護者（カードトラッカーを所持して監視される）を想定し、スマホを持たない被保護者（幼児や老人）にトラッカーを持ち歩かせ、彼らの位置情報を保護者がwebアプリで追跡することを考えている。

機能1では、部屋にいるかどうかを見守ることを考えており、部屋から出てしまった場合、画面で警告(赤色ポップアップなど)を用いて知らせる。ビーコン3台による位置の特定を生かした機能である。
機能2ではバスなど移動物にビーコン1台を固定しておき、ビーコンが検知するトラッカーの数をチェック。そのビーコンからBLEを受信しているトラッカー(被保護者)が1台のみの状態が3分続けば、バスから降り忘れている疑いがある（近年、通園バスに幼児を置き去りする事件が多発している）とし、警告を表示させる。
機能3では散歩など屋外にいる際に、保護者（親トラッカー）から被保護者（子トラッカー）が逸れてしまっていないかをGPSでチェックする（いずれの親トラッカーから30m以上離れてしまった場合逸れたと検知し、この値はUIで変更できるようにする）。誰か逸れてしまった場合は警告を表示させることを考えている。

ゲートウェイは建物に固定したままであり、機能2,3はRoLa通信が届く距離の長さを生かした機能である。機能1、 2はBLE機能を用い、機能3だけGPS機能を用いる。トラッカーからのデータ送信頻度は１分間隔を想定している（1分毎にrtdbが更新される）。
機能1(ビーコン×3)
ビーコン3つを部屋に固定し、部屋のどこにトラッカー所持者らがいるかを確認できる機能。使うモデルはFingerPrintingでしょうか。適切なモデルを使用してください。
機能2(ビーコン×1)
ビーコンを持ち運んでいるとし、ビーコンからトラッカー所持者らが一定の範囲内にいるかを確認できる機能。
機能3(ビーコン×0)
親トラッカー(GPS機能あり)を1つ以上決め、他の子トラッカーが親トラッカーから離れていないか確認する機能。
UI指示
機能1〜3は同時に使うのではなく、１つのみを有効にでき、管理画面で保護者が手動で切り替えることを想定している。切り替えた先の機能でキャリブレーションが必要なのに、まだされていない場合は、キャリブレーション画面に自動遷移するようにしてください。
マップが表示されている基本画面
機能1では、部屋のマップとカードトラッカー所持者の位置を大きく表示
機能2では、ビーコンを中心としたマップを大きく表示
機能3では、トラッカーのGPS機能を使って、大まかなトラッカーの位置情報の表示
機能1〜3を通じて、画面全体で警告（音と共に）を知らせる通知を行う
キャリブレーション・マップカスタマイズ画面
キャリブレーション案で詳細を示す
管理画面
トラッカーの登録（トラッカーとユーザー名の対応付け）
ビーコンの登録（ビーコンの名前付け）
キャリブレでは名前のあるビーコンをマップ上に配置できるようにする。
キャリブレーション案（機能1向け）
1. この機能の目的は？
新しい部屋にビーコンを3つ置いただけでは、システムはトラッカーがどこにいるか分かりません。
この「部屋スキャン」機能は、その部屋専用の「電波の地図」をシステムに作らせるための準備作業です。この地図があることで、その部屋でどの位置にいるかが分かるようになります。
2. この機能でやること
システムに「会議室A」のような新しい部屋の名前と、そこに置いたビーコン3つのIDを登録(他の部屋で使ってるビーコンを使い回すのが基本)すること。
LoRaカードトラッカーを持って部屋を歩き回り、指示された場所で電波の強さを記録していくこと（スキャン作業）。
記録したデータをシステムに送ると、その部屋専用の「電波の地図（部屋プロファイル）」が自動で作られること。
ちゃんと地図が作れたか、最後に簡単なテストができること。
3. この機能を使う人
一般人、主に保護者（非技術者でもできるようなUI,説明）
4. 具体的にできること（機能のリスト）
【ステップ1：準備】
部屋の新規登録
管理画面から、新しい部屋の名前（例:「会議室A」）と、そこに設置したビーコン3つのIDを登録(もしくは再利用)できます。
ビーコンの設置


【ステップ2：スキャン作業】
スキャン開始
アプリなどで、作業する部屋（例:「会議室A」）を選んで「スキャン開始」ボタンを押します。
部屋の中を測定 (5ヶ所)
画面に「①部屋の隅に行ってください」のように、次に行く場所が分かりやすく表示されます。測定に使用するトラッカーは測定点ごとに選択できるようにする。
指示された場所に着いたら「ここで測定」ボタンを押します。
「測定中…」と表示され、RTDBのそのトラッカーにおける値が変わったら、その値を測定結果と判定して使用する。
完了すると「OKです。次は左回りで次の隅に行ってください」」のように、次の指示が出ます。4点計測した後は、部屋の中央で測定します。
これを合計5ヶ所（部屋の４隅+部屋の中央）で繰り返します。
出入口を測定 (2ヶ所)
部屋の中の測定が終わると、次に「ドアの内側で測定してください」「ドアの外側で測定してください」という指示が出ます。
同じように2ヶ所で測定します。
また、部屋に出入口が２つ以上ある場合も想定してください。
データ送信
全部の測定が終わると「完了してデータを送信」ボタンが表示されるので、それを押します。これで現場の作業は終わりです。
【ステップ3：電波の地図づくり（システムが自動でやること）】
「電波の地図」の作成と保存
現場からデータが送られてくると、システムが自動で計算を始めます。
その部屋の「どこで、どんな強さの電波が受信できるか」をまとめた、その部屋専用の「電波の地図（部屋プロファイル）」が作られ、保存されます。
【ステップ4：最後のチェック】
テスト機能
地図が完成すると、アプリに「テストをしますか？」と表示されます。
「はい」を選ぶと、「部屋の真ん中にトラッカーを置いてください」と指示が出ます。
トラッカーを置くと、画面に「実際の場所とのズレ： 約 〇〇 cm」のように、どれだけ正確かが表示されます。
この結果を見て、作業員さんは「この設定でOK」か「もう一度やり直す」かを選べます。
キャリブレーション点追加機能
部屋の4隅やドアの出入り口だけのキャリブレーションでは、不安定な可能性が高いです。そのため、作成された部屋の任意の場所に点をおき、そこでのトラッカーのBLE測定結果も使用できるようにする。このようなキャリブレーション点追加機能は、キャリブレーション後いつでも追加できるようにする。
【ステップ5：家具配置】
マップを見やすくする
マップのアウトライン生成後に、簡易的にユーザーが事前に用意された家具等オブジェクトを配置できるようにする（机、テレビ、ピアノ、ドアなど）。
ビーコンの位置は自動取得できないだろうから、ここでセットしたビーコン3つの位置をマップ上に記録。

5. 使いやすさなどの大事なこと
かんたんな操作: 誰でもマニュアルなしで使えるように、アプリのボタンや指示はシンプルで分かりやすくします。
途中で失敗しても安心: もし測定の途中でアプリが止まっても、かんたんにやり直せるようにします。
速さ: 現場でデータを送信してから、「電波の地図」ができるまでの待ち時間は30秒以内にします。
特定の位置だけ再キャリブレーションできる機能も用意。


キャリブレーション案（機能2向け)
どのビーコン1台を使用するか決定する。

キャリブレーション案（機能3向け)
ビーコンは使わないので、ビーコンのキャリブレーションは不要。UIで機能3に切り替え、親トラッカーを選択できるようにするだけで良い。


BLEビーコン設置場所候補・注意点
	BLEビーコン注意点
金属やコンクリートの壁などの障害物が多い環境
他デバイスの電波が多い環境では精度が低くなる可能性あり
	BLEビーコン設置場所候補
壁への設置が主流
床から1.5〜2m以上の高さの位置の設置がベスト
会場にはドアが２つあるため、２つのドア上の時計の直下へのビーコンの設置が望ましい
残り１つについては、会場窓側の中間地点
部屋の出入りを監視したいなら、ドアの正面方向の壁に設置すると良いかも
	BLEビーコン設置方法
両面/ガムテープ

使用デバイス
BLE beacon(×3)　　　　：MM-BLEBC4
LoRa カードトラッカー  ：SenceCAP T1000-A LoRa WAN 
(Card A) EUI : 2CF7F1C07030002F
(Card B) EUI : 2CF7F1C06490088C
(Card C) EUI : 2CF7F1C0703000AD
LoRa WAN ゲートウェイ：sense cap M2マルチプラットフォームLoRaWAN

Firestore/RealtimeDatabase(RTDB)に保存される値

1) デバイス台帳　デバイスの管理
firestore
devices/{Id}/（Id は firestoreが自動で決定）
```json
{
  "deviceId": "CARD-A",           // CARD-A, CARD-B, ...
  "devEUI": "11:22:33:44:55:66",      
  "model": "SenseCAP T1000-A",
  "ownerUid": "<FirebaseAuth UID>",
  "status": "active",
  "tags": {
    "username": "(ユーザー名)"
  },
  "lorawan": { "devEUI": "...", "joinEUI": "...", "appEUI": "..." }, // 鍵はSecret Managerへ
  "firmware": "1.2.0",
}
```

2) トラッカー観測データ
``` json
{
  "tracker": {
    "trackerID": {
      "ts": "2025-10-14T12:34:56Z",             // 観測の基準時刻（端末生成時刻）
      "server_ts": { ".sv": "timestamp" },       // サーバ受信時刻（ミリ秒）
      "seq": 128,                                 // 任意: 端末側の連番/フレーム番号（欠落検知に便利）
      "battery_dV": 39,                           // 任意: 3.9V→39（10倍整数など）

      "gps": {
        "lat": 38.2601,
        "lon": 140.8699,
        "alt": 67.2,
        "hdop": 0.9,                              // or "acc_m": 5.3
        "speed_mps": 0.7,
        "fix": true                               // 任意: 有効Fixか（失敗時はfalse/欠落）
      },

      "ble": {
        "beaconId": { // 複数のビーコン(DEVICE1, DEVICE2, DEVICE3)から送られてくる
          "channel": 37,                            // 任意
          "scanner": { "kind": "tracker", "appVer": "1.0.0" }, // 任意
          "loc_hint": { "lat": 38.26, "lon": 140.87 },         // 任意
          "rssi_data": [
            { "mac": "AA:BB:CC:DD:EE:01", "rssi": -68, "txPower": 4 }, // 1つのビーコンから最大3つの観測値が送られてくる
            { "mac": "AA:BB:CC:DD:EE:01", "rssi": -72, "txPower": 4 }
          ]
        }
      },

      "status": "ok",                              // 任意: "ok" | "degraded" | "no_gps" | "no_ble" など
      "tags": ["person","asset"],                  // 任意
      "_v": 1                                      // スキーマバージョン
    }
  }
}
```

クエリ最適化のためのフラットインデックス（後で追加）
 rssi_samples コレクションに“1ビーコン1ドキュメント”でファンアウト保存すると、「特定ビーコン×期間のRSSI履歴」を高速に引けます。
3) ビーコン台帳（固定機器・設置物）
firestore
beacons/{Id}/（Id は firestoreが自動で決定）
``` json
{
  "mac": "AA:BB:CC:DD:EE:FF",             
  "beaconId": "DEVICE1",         // DEVICE1~3まである
  "rssiAt1m": -59,               // キャリブ基準
  "tags": {
    "type": ["ibeacon"]
  }
}

```


```


4) 位置融合（GPS + BLE + 地図）
realtime database

ここは、バックエンドで受け取った電波強度とキャリブレーションデータを元に、

サーバ側推定の結果を保存する。可視化や履歴検索はここを主に使う。
 devices/{deviceId}/fused_positions/{posId}
``` json
{
  "ts": { "_seconds": 173... },
  "loc": { "lat": 38.26008, "lon": 140.86992, "floor": 3 },
  "xy": { "x": 12.84, "y": 7.21 },         // フロア内ローカル座標 [座標は0~1で正規化して表示するのが良いかも]
  "cov_xy": [[0.52, 0.10], [0.10, 0.30]],  // 不確かさ（共分散） or
  "uncertainty_ellipse": {			　　　//必要なければ削除
    "semi_major": 1.0,
    "semi_minor": 0.6,
    "theta_deg": 30.0
  },
  "method": "gps_only|ble_trilateration|kalman|particle", //必要なければ削除
  "confidence": 0.82,
  "inputs": {
    "gps_ref": "gps_fixes/2025-10-14T12:34:56Z",
    "scan_ref": "ble_scans/2025-10-14T12:34:55Z",
    "beacons_used": ["beacons/AA..", "beacons/BB.."]
  }
}



```

カードデバイスからLoRaへのデータ
3このBLEデータとgpsデータを格納
``` json
{
  "time": "2025-10-14T12:34:56Z",
  "gps": { "lat_e5": 3826010, "lon_e5": 14086990, "acc_m": 6 },
  "battery_dV": 39,         // 3.9V を10倍整数など　任意
  "beacons": [
    { "id3": "01FFAA", "rssi": -66 },
    { "id3": "02BBCC", "rssi": -74 },
    { "id3": "03CCDD", "rssi": -81 }
  ]
}

```